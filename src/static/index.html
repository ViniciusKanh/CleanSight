<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CleanSight - Visualização e Transformação de Dados</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 50%, #e2e8f0 100%);
            color: #1e293b;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animação de partículas azuis */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .particle {
            position: absolute;
            width: 3px;
            height: 3px;
            background: #3b82f6;
            border-radius: 50%;
            animation: float 8s infinite linear;
            opacity: 0.4;
        }

        @keyframes float {
            0% {
                transform: translateY(100vh) translateX(0px);
                opacity: 0;
            }
            10% {
                opacity: 0.4;
            }
            90% {
                opacity: 0.4;
            }
            100% {
                transform: translateY(-100px) translateX(50px);
                opacity: 0;
            }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 2;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 0;
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.1);
            border: 1px solid #e2e8f0;
        }

        .logo {
            font-size: 3rem;
            font-weight: bold;
            background: linear-gradient(45deg, #3b82f6, #1d4ed8, #2563eb);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradientShift 3s ease-in-out infinite;
            margin-bottom: 10px;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .subtitle {
            font-size: 1.1rem;
            color: #64748b;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 25px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.08);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(59, 130, 246, 0.15);
        }

        .card-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title .icon {
            font-size: 1.5rem;
        }

        .upload-area {
            border: 2px dashed #3b82f6;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        }

        .upload-area:hover {
            border-color: #1d4ed8;
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            transform: scale(1.01);
        }

        .upload-area.dragover {
            border-color: #2563eb;
            background: linear-gradient(135deg, #bfdbfe 0%, #93c5fd 100%);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3rem;
            color: #3b82f6;
            margin-bottom: 15px;
        }

        .btn {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 8px;
            box-shadow: 0 2px 10px rgba(59, 130, 246, 0.3);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            background: #94a3b8;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            box-shadow: 0 2px 10px rgba(100, 116, 139, 0.3);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #475569 0%, #334155 100%);
            box-shadow: 0 4px 15px rgba(100, 116, 139, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 2px 10px rgba(16, 185, 129, 0.3);
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            color: #374151;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .checkbox-item:hover {
            background: #eff6ff;
            border-color: #3b82f6;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #3b82f6;
        }

        .checkbox-item.checked {
            background: #eff6ff;
            border-color: #3b82f6;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-item {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #bfdbfe;
            transition: all 0.3s ease;
        }

        .stat-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2);
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #1d4ed8;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #64748b;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 30px;
        }

        .spinner {
            border: 3px solid #e5e7eb;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border: 2px solid #fca5a5;
            color: #dc2626;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .success {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 2px solid #86efac;
            color: #16a34a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .columns-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .column-item {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .column-item:hover {
            background: #eff6ff;
            border-color: #3b82f6;
        }

        .column-name {
            font-weight: 600;
            color: #1d4ed8;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .column-info {
            font-size: 0.85rem;
            color: #64748b;
            line-height: 1.4;
        }

        .config-section {
            background: #f8fafc;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            margin: 20px 0;
        }

        .config-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .number-input {
            width: 100px;
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            text-align: center;
        }

        .number-input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 3% auto;
            padding: 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
        }

        .close {
            color: #64748b;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #1e293b;
        }

        .plot-container {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .plot-container img {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .describe-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .describe-table th,
        .describe-table td {
            border: 1px solid #e2e8f0;
            padding: 8px;
            font-size: 0.9rem;
            text-align: center;
        }

        .describe-table th {
            background: #eff6ff;
        }

        .describe-table tbody tr:nth-child(even) {
            background: #f8fafc;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #2563eb);
            width: 0%;
            transition: width 0.3s ease;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .logo {
                font-size: 2.2rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .columns-grid {
                grid-template-columns: 1fr;
            }

            .checkbox-group {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
                align-items: stretch;
            }

            .btn {
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>
    <!-- Partículas animadas -->
    <div class="particles" id="particles"></div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">CleanSight</div>
            <div class="subtitle">Visualização e Transformação Inteligente de Dados</div>
        </div>

        <!-- Upload Section -->
        <div class="card" id="uploadSection">
            <div class="card-title">
                <span class="icon">📊</span>
                Upload do Dataset
            </div>
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">📁</div>
                <h3>Arraste seu arquivo aqui ou clique para selecionar</h3>
                <p>Suporte para CSV, TXT, TSV (máximo 50MB)</p>
                <input type="file" id="fileInput" accept=".csv,.txt,.tsv" style="display: none;">
            </div>
            <div id="uploadStatus"></div>
        </div>

        <!-- Dataset Info Section -->
        <div class="card hidden" id="datasetInfoSection">
            <div class="card-title">
                <span class="icon">📋</span>
                Informações do Dataset
            </div>
            <div id="datasetInfo"></div>
            
            <div class="form-group">
                <label for="targetSelect">Selecione a Coluna Target (Variável Dependente):</label>
                <select id="targetSelect" class="form-control">
                    <option value="">Selecione uma coluna...</option>
                </select>
                <small style="color: #64748b; margin-top: 5px; display: block;">
                    A coluna target será usada para classificação e seleção de features
                </small>
            </div>
            
            <div class="button-group">
                <button class="btn" id="analyzeBtn" disabled>Analisar Dataset</button>
            </div>
        </div>

        <!-- Analysis Section -->
        <div class="card hidden" id="analysisSection">
            <div class="card-title">
                <span class="icon">📈</span>
                Análise Inicial
            </div>
            <div id="analysisResults"></div>
            
            <!-- Configurações de Processamento -->
            <div class="config-section">
                <div class="config-title">
                    <span class="icon">🔧</span>
                    Configurações de Pré-processamento
                </div>
                
                <div class="checkbox-group">
                    <div class="checkbox-item" onclick="toggleCheckbox('treatMissing')">
                        <input type="checkbox" id="treatMissing" checked>
                        <div>
                            <strong>Tratar Valores Ausentes</strong>
                            <div style="font-size: 0.85rem; color: #64748b;">Preenche valores faltantes com média/moda</div>
                        </div>
                    </div>
                    
                    <div class="checkbox-item" onclick="toggleCheckbox('removeDuplicates')">
                        <input type="checkbox" id="removeDuplicates" checked>
                        <div>
                            <strong>Remover Duplicatas</strong>
                            <div style="font-size: 0.85rem; color: #64748b;">Remove linhas idênticas do dataset</div>
                        </div>
                    </div>
                    
                    <div class="checkbox-item" onclick="toggleCheckbox('encodeCategories')">
                        <input type="checkbox" id="encodeCategories" checked>
                        <div>
                            <strong>Codificar Categóricas</strong>
                            <div style="font-size: 0.85rem; color: #64748b;">Converte texto em números para ML</div>
                        </div>
                    </div>
                    
                    <div class="checkbox-item" onclick="toggleCheckbox('removeOutliers')">
                        <input type="checkbox" id="removeOutliers">
                        <div>
                            <strong>Detectar Outliers</strong>
                            <div style="font-size: 0.85rem; color: #64748b;">Identifica valores anômalos nos dados</div>
                        </div>
                    </div>
                    
                    <div class="checkbox-item" onclick="toggleCheckbox('normalizeData')">
                        <input type="checkbox" id="normalizeData">
                        <div>
                            <strong>Normalizar Dados</strong>
                            <div style="font-size: 0.85rem; color: #64748b;">Padroniza escalas das variáveis</div>
                        </div>
                    </div>
                    
                    <div class="checkbox-item" onclick="toggleCheckbox('balanceClasses')">
                        <input type="checkbox" id="balanceClasses">
                        <div>
                            <strong>Balancear Classes</strong>
                            <div style="font-size: 0.85rem; color: #64748b;">Equilibra distribuição das classes</div>
                        </div>
                    </div>
                </div>

                <!-- Seleção de Features -->
                <div style="margin-top: 25px;">
                    <div class="checkbox-item" onclick="toggleCheckbox('selectFeatures')">
                        <input type="checkbox" id="selectFeatures" checked>
                        <div>
                            <strong>Seleção de Features</strong>
                            <div style="font-size: 0.85rem; color: #64748b;">Escolhe as melhores variáveis para o modelo</div>
                        </div>
                    </div>
                    
                    <div id="featureSelectionConfig" style="margin-top: 15px; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e2e8f0;">
                        <label for="numFeatures" style="display: block; margin-bottom: 8px; font-weight: 600;">
                            Quantas features você quer manter?
                        </label>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <input type="number" id="numFeatures" class="number-input" value="50" min="1" max="100">
                            <span style="color: #64748b;">% das melhores features</span>
                        </div>
                        <small style="color: #64748b; margin-top: 5px; display: block;">
                            Exemplo: 50% significa que se você tem 20 colunas, vai ficar com 10
                        </small>
                    </div>
                </div>
            </div>
            
            <div class="button-group">
                <button class="btn" id="processBtn">🚀 Processar Dataset</button>
                <button class="btn btn-secondary" id="statisticsBtn">📊 Análise Estatística</button>
                <button class="btn btn-secondary" id="profilingBtn">🔍 Perfil do Dataset</button>
                <button class="btn btn-success" id="pcaBtn" disabled>📈 Gráfico PCA 2D</button>
                <button class="btn btn-secondary" id="outliersBtn" disabled>🎯 Gráfico de Outliers</button>
            </div>
        </div>

        <!-- Results Section -->
        <div class="card hidden" id="resultsSection">
            <div class="card-title">
                <span class="icon">✅</span>
                Resultados do Processamento
            </div>
            <div id="processingResults"></div>
            
            <div class="button-group">
                <button class="btn btn-success" id="downloadBtn">💾 Download Dataset Processado</button>
                <button class="btn btn-secondary" id="clearBtn">🔄 Limpar e Processar Novo Dataset</button>
            </div>
        </div>
    </div>

    <!-- Modal para gráficos -->
    <div id="plotModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        // Variáveis globais
        let currentFile = null;
        let targetColumn = null;
        let datasetInfo = null;

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            createParticles();
            setupEventListeners();
        });

        // Cria partículas animadas
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            const particleCount = 30;

            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 8 + 's';
                particle.style.animationDuration = (Math.random() * 4 + 6) + 's';
                particlesContainer.appendChild(particle);
            }
        }

        // Configura event listeners
        function setupEventListeners() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const targetSelect = document.getElementById('targetSelect');
            const analyzeBtn = document.getElementById('analyzeBtn');
            const processBtn = document.getElementById('processBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const clearBtn = document.getElementById('clearBtn');
            const statisticsBtn = document.getElementById('statisticsBtn');
            const profilingBtn = document.getElementById('profilingBtn');
            const pcaBtn = document.getElementById('pcaBtn');
            const outliersBtn = document.getElementById('outliersBtn');

            // Upload events
            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('drop', handleDrop);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            fileInput.addEventListener('change', handleFileSelect);

            // Other events
            targetSelect.addEventListener('change', handleTargetSelect);
            analyzeBtn.addEventListener('click', analyzeDataset);
            processBtn.addEventListener('click', processDataset);
            downloadBtn.addEventListener('click', downloadProcessed);
            clearBtn.addEventListener('click', clearSession);
            statisticsBtn.addEventListener('click', generateStatistics);
            profilingBtn.addEventListener('click', generateProfiling);
            pcaBtn.addEventListener('click', generatePCA);
            outliersBtn.addEventListener('click', generateOutliers);

            // Modal events
            const modal = document.getElementById('plotModal');
            const closeBtn = document.querySelector('.close');
            closeBtn.addEventListener('click', () => modal.style.display = 'none');
            window.addEventListener('click', (e) => {
                if (e.target === modal) modal.style.display = 'none';
            });

            // Checkbox events
            document.getElementById('selectFeatures').addEventListener('change', function() {
                const config = document.getElementById('featureSelectionConfig');
                config.style.display = this.checked ? 'block' : 'none';
            });
        }

        // Função para toggle de checkbox
        function toggleCheckbox(id) {
            const checkbox = document.getElementById(id);
            checkbox.checked = !checkbox.checked;
            
            // Atualiza visual
            const item = checkbox.closest('.checkbox-item');
            if (checkbox.checked) {
                item.classList.add('checked');
            } else {
                item.classList.remove('checked');
            }

            // Trigger change event
            checkbox.dispatchEvent(new Event('change'));
        }

        // Handlers de drag and drop
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        // Processa arquivo selecionado
        function handleFile(file) {
            currentFile = file;
            uploadFile(file);
        }

        // Upload do arquivo
        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);

            showLoading('uploadStatus', 'Fazendo upload e analisando arquivo...');

            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    datasetInfo = result.info;
                    showDatasetInfo(result.info);
                    showSuccess('uploadStatus', 'Arquivo carregado com sucesso!');
                } else {
                    showError('uploadStatus', result.error || 'Erro no upload do arquivo');
                }
            } catch (error) {
                showError('uploadStatus', 'Erro de conexão: ' + error.message);
            }
        }

        // Mostra informações do dataset
        function showDatasetInfo(info) {
            const datasetInfoSection = document.getElementById('datasetInfoSection');
            const datasetInfo = document.getElementById('datasetInfo');
            const targetSelect = document.getElementById('targetSelect');

            // Estatísticas básicas
            const statsHtml = `
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value">${info.filename}</div>
                        <div class="stat-label">Nome do Arquivo</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${info.shape[0].toLocaleString()}</div>
                        <div class="stat-label">Linhas</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${info.shape[1]}</div>
                        <div class="stat-label">Colunas</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${info.duplicates}</div>
                        <div class="stat-label">Duplicatas</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${info.data_quality.completeness.toFixed(1)}%</div>
                        <div class="stat-label">Completude</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${info.encoding_used}</div>
                        <div class="stat-label">Encoding</div>
                    </div>
                </div>
            `;

            // Colunas disponíveis
            const columnsHtml = `
                <h3 style="margin: 25px 0 15px 0; color: #1e293b;">📋 Colunas Disponíveis</h3>
                <div class="columns-grid">
                    ${info.columns.map(col => `
                        <div class="column-item">
                            <div class="column-name">${col}</div>
                            <div class="column-info">
                                Tipo: ${info.dtypes[col]}<br>
                                Únicos: ${info.unique_values[col]}<br>
                                ${info.missing_values[col] > 0 ? `Ausentes: ${info.missing_values[col]}` : 'Completo ✓'}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            datasetInfo.innerHTML = statsHtml + columnsHtml;

            // Popula select de target
            targetSelect.innerHTML = '<option value="">Selecione uma coluna...</option>';
            info.columns.forEach(col => {
                const option = document.createElement('option');
                option.value = col;
                option.textContent = `${col} (${info.dtypes[col]})`;
                targetSelect.appendChild(option);
            });

            datasetInfoSection.classList.remove('hidden');
        }

        // Handler para seleção de target
        function handleTargetSelect(e) {
            targetColumn = e.target.value;
            const analyzeBtn = document.getElementById('analyzeBtn');
            analyzeBtn.disabled = !targetColumn;
        }

        // Analisa dataset
        async function analyzeDataset() {
            if (!targetColumn) {
                showError('analysisResults', 'Selecione uma coluna target primeiro');
                return;
            }

            showLoading('analysisResults', 'Analisando dataset e coluna target...');

            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        target_column: targetColumn
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showAnalysisResults(result.analysis);
                    document.getElementById('analysisSection').classList.remove('hidden');
                    
                    // Habilita botões
                    document.getElementById('pcaBtn').disabled = false;
                    document.getElementById('outliersBtn').disabled = false;
                } else {
                    showError('analysisResults', result.error || 'Erro na análise');
                }
            } catch (error) {
                showError('analysisResults', 'Erro de conexão: ' + error.message);
            }
        }

        // Mostra resultados da análise
        function showAnalysisResults(analysis) {
            const analysisResults = document.getElementById('analysisResults');

            const html = `
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value">${analysis.target_column}</div>
                        <div class="stat-label">Coluna Target</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${Object.keys(analysis.target_classes).length}</div>
                        <div class="stat-label">Classes Únicas</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${(analysis.target_balance_ratio * 100).toFixed(1)}%</div>
                        <div class="stat-label">Balanceamento</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${analysis.total_missing_percentage.toFixed(1)}%</div>
                        <div class="stat-label">Valores Ausentes</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${analysis.numeric_columns_count}</div>
                        <div class="stat-label">Colunas Numéricas</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${analysis.categorical_columns_count}</div>
                        <div class="stat-label">Colunas Categóricas</div>
                    </div>
                </div>

                <h3 style="margin: 25px 0 15px 0; color: #1e293b;">🎯 Distribuição das Classes</h3>
                <div class="columns-grid">
                    ${Object.entries(analysis.target_classes).map(([classe, count]) => `
                        <div class="column-item">
                            <div class="column-name">${classe}</div>
                            <div class="column-info">${count.toLocaleString()} amostras (${((count / Object.values(analysis.target_classes).reduce((a,b) => a+b, 0)) * 100).toFixed(1)}%)</div>
                        </div>
                    `).join('')}
                </div>

                ${analysis.ml_readiness.recommendation.length > 0 ? `
                    <div style="background: #fffbeb; border: 2px solid #fbbf24; border-radius: 8px; padding: 15px; margin-top: 20px;">
                        <h4 style="color: #92400e; margin-bottom: 10px;">💡 Recomendações:</h4>
                        <ul style="color: #92400e; margin-left: 20px;">
                            ${analysis.ml_readiness.recommendation.map(rec => `<li>${rec}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
            `;

            analysisResults.innerHTML = html;
        }

        // Processa dataset
        async function processDataset() {
            if (!targetColumn) {
                showError('processingResults', 'Selecione uma coluna target primeiro');
                return;
            }

            // Coleta configurações
            const config = {
                treat_missing: document.getElementById('treatMissing').checked,
                remove_duplicates: document.getElementById('removeDuplicates').checked,
                encode_categories: document.getElementById('encodeCategories').checked,
                remove_outliers: document.getElementById('removeOutliers').checked,
                normalize_data: document.getElementById('normalizeData').checked,
                balance_classes: document.getElementById('balanceClasses').checked,
                select_features: document.getElementById('selectFeatures').checked,
                num_features_percent: parseInt(document.getElementById('numFeatures').value) || 50
            };

            showLoading('processingResults', 'Processando dataset com suas configurações...');

            try {
                const response = await fetch('/api/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        target_column: targetColumn,
                        config: config
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showProcessingResults(result);
                    document.getElementById('resultsSection').classList.remove('hidden');
                } else {
                    showError('processingResults', result.error || 'Erro no processamento');
                }
            } catch (error) {
                showError('processingResults', 'Erro de conexão: ' + error.message);
            }
        }

        // Mostra resultados do processamento
        function showProcessingResults(result) {
            const processingResults = document.getElementById('processingResults');
            const stats = result.processing_stats;

            const html = `
                <div class="success">
                    ✅ Dataset processado com sucesso!
                </div>

                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value">${stats.original_rows.toLocaleString()}</div>
                        <div class="stat-label">Linhas Originais</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${stats.final_rows.toLocaleString()}</div>
                        <div class="stat-label">Linhas Finais</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${stats.original_columns}</div>
                        <div class="stat-label">Colunas Originais</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${stats.final_columns}</div>
                        <div class="stat-label">Colunas Finais</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${stats.features_selected}</div>
                        <div class="stat-label">Features Selecionadas</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${stats.missing_values_treated}</div>
                        <div class="stat-label">Valores Tratados</div>
                    </div>
                </div>

                <h3 style="margin: 25px 0 15px 0; color: #1e293b;">📊 Estatísticas de Processamento</h3>
                <div style="background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0;">
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        <li style="padding: 8px 0; border-bottom: 1px solid #e2e8f0;">✅ Duplicatas removidas: <strong>${stats.duplicates_removed}</strong></li>
                        <li style="padding: 8px 0; border-bottom: 1px solid #e2e8f0;">✅ Valores ausentes tratados: <strong>${stats.missing_values_treated}</strong></li>
                        <li style="padding: 8px 0; border-bottom: 1px solid #e2e8f0;">✅ Variáveis categóricas codificadas: <strong>${stats.categorical_encoded}</strong></li>
                        <li style="padding: 8px 0; border-bottom: 1px solid #e2e8f0;">✅ Features selecionadas: <strong>${stats.features_selected}</strong></li>
                        <li style="padding: 8px 0;">✅ Coluna target codificada automaticamente</li>
                    </ul>
                </div>

                <h3 style="margin: 25px 0 15px 0; color: #1e293b;">🎯 Colunas Finais</h3>
                <div class="columns-grid">
                    ${result.final_columns.map(col => `
                        <div class="column-item">
                            <div class="column-name">${col}</div>
                        </div>
                    `).join('')}
                </div>
            `;

            processingResults.innerHTML = html;
        }

        // Download do arquivo processado
        async function downloadProcessed() {
            try {
                const response = await fetch('/api/download');
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'processed_dataset.csv';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    const result = await response.json();
                    showError('processingResults', result.error || 'Erro no download');
                }
            } catch (error) {
                showError('processingResults', 'Erro de conexão: ' + error.message);
            }
        }

        // Limpa sessão
        async function clearSession() {
            if (confirm('Tem certeza que deseja limpar tudo e começar novamente?')) {
                try {
                    await fetch('/api/clear', { method: 'POST' });
                    
                    // Reset da interface
                    currentFile = null;
                    targetColumn = null;
                    datasetInfo = null;
                    
                    document.getElementById('datasetInfoSection').classList.add('hidden');
                    document.getElementById('analysisSection').classList.add('hidden');
                    document.getElementById('resultsSection').classList.add('hidden');
                    
                    document.getElementById('uploadStatus').innerHTML = '';
                    document.getElementById('fileInput').value = '';
                    document.getElementById('analyzeBtn').disabled = true;
                    document.getElementById('pcaBtn').disabled = true;
                    document.getElementById('outliersBtn').disabled = true;
                    
                    // Reset checkboxes
                    document.getElementById('treatMissing').checked = true;
                    document.getElementById('removeDuplicates').checked = true;
                    document.getElementById('encodeCategories').checked = true;
                    document.getElementById('removeOutliers').checked = false;
                    document.getElementById('normalizeData').checked = false;
                    document.getElementById('balanceClasses').checked = false;
                    document.getElementById('selectFeatures').checked = true;
                    document.getElementById('numFeatures').value = 50;
                    
                    showSuccess('uploadStatus', 'Sessão limpa! Você pode fazer upload de um novo arquivo.');
                } catch (error) {
                    showError('uploadStatus', 'Erro ao limpar sessão: ' + error.message);
                }
            }
        }

        // Gera estatísticas visuais
        async function generateStatistics() {
            if (!targetColumn) return;

            try {
                const response = await fetch('/api/statistics', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        target_column: targetColumn
                    })
                });

                const result = await response.json();

                if (result.success) {
                    let tableHtml = '';
                    if (result.describe_table) {
                        tableHtml = createDescribeTable(result.describe_table);
                    }
                    let profilingHtml = '';
                    if (result.profiling_report) {
                        profilingHtml = `
                            <details style="margin-top: 20px;">
                                <summary style="cursor: pointer; font-weight: 600;">📑 Relatório de Profiling</summary>
                                <div>${result.profiling_report}</div>
                            </details>
                        `;
                    }
                    showModal('📊 Análise Estatística Completa', `
                        <div class="plot-container">
                            <h3>Matriz de Correlação</h3>
                            <img src="${result.plots.correlation_matrix}" alt="Matriz de Correlação">
                        </div>
                        <div class="plot-container">
                            <h3>Distribuições das Variáveis</h3>
                            <img src="${result.plots.distribution_plots}" alt="Distribuições">
                        </div>
                        <div class="plot-container">
                            <h3>Box Plots</h3>
                            <img src="${result.plots.boxplots}" alt="Box Plots">
                        </div>
                        <div class="plot-container">
                            <h3>Distribuição da Target</h3>
                            <img src="${result.plots.target_distribution}" alt="Target Distribution">
                        </div>
                        <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-top: 20px;">
                            <h4>📈 Resumo Estatístico</h4>
                            <p><strong>Total de Features:</strong> ${result.statistics_summary.total_features}</p>
                            <p><strong>Features Numéricas:</strong> ${result.statistics_summary.numeric_features}</p>
                            <p><strong>Features Categóricas:</strong> ${result.statistics_summary.categorical_features}</p>
                            <p><strong>Score de Qualidade:</strong> ${result.statistics_summary.data_quality_score.toFixed(1)}%</p>
                        </div>
                        ${tableHtml}
                        ${profilingHtml}
                    `);
                } else {
                    showError('analysisResults', result.error || 'Erro ao gerar estatísticas');
                }
            } catch (error) {
                showError('analysisResults', 'Erro de conexão: ' + error.message);
            }
        }

        async function generateProfiling() {
            if (!targetColumn) return;

            try {
                const response = await fetch('/api/statistics', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        target_column: targetColumn
                    })
                });

                const result = await response.json();

                if (result.success && result.profiling_report) {
                    window.profilingReportHTML = result.profiling_report;
                    openProfiling();
                } else {
                    alert('Perfilamento indisponível.');
                }
            } catch (error) {
                alert('Erro ao gerar perfilamento: ' + error.message);
            }
        }

        // Gera gráfico PCA
        async function generatePCA() {
            if (!targetColumn) return;

            try {
                const response = await fetch('/api/pca', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        target_column: targetColumn
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showModal('📈 Análise PCA 2D', `
                        <div class="plot-container">
                            <h3>Visualização PCA 2D</h3>
                            <img src="${result.pca_plot}" alt="PCA 2D">
                        </div>
                        <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-top: 20px;">
                            <h4>📊 Informações do PCA</h4>
                            <p><strong>Variância Explicada PC1:</strong> ${(result.explained_variance[0] * 100).toFixed(1)}%</p>
                            <p><strong>Variância Explicada PC2:</strong> ${(result.explained_variance[1] * 100).toFixed(1)}%</p>
                            <p><strong>Variância Total:</strong> ${(result.cumulative_variance * 100).toFixed(1)}%</p>
                            <div style="margin-top: 15px;">
                                <p><strong>Interpretação:</strong></p>
                                <p>• ${result.pca_interpretation.pc1_description}</p>
                                <p>• ${result.pca_interpretation.pc2_description}</p>
                                <p>• ${result.pca_interpretation.recommendation}</p>
                            </div>
                        </div>
                    `);
                } else {
                    showError('analysisResults', result.error || 'Erro ao gerar PCA');
                }
            } catch (error) {
                showError('analysisResults', 'Erro de conexão: ' + error.message);
            }
        }

        // Gera gráfico de outliers
        async function generateOutliers() {
            if (!targetColumn) return;

            try {
                const response = await fetch('/api/outliers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        target_column: targetColumn
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showModal('🎯 Detecção de Outliers', `
                        <div class="plot-container">
                            <h3>Visualização de Outliers</h3>
                            <img src="${result.outliers_plot}" alt="Outliers">
                        </div>
                        <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-top: 20px;">
                            <h4>📊 Estatísticas de Outliers</h4>
                            <p><strong>Outliers Detectados:</strong> ${result.outliers_count}</p>
                            <p><strong>Percentual:</strong> ${result.outliers_percentage}% do dataset</p>
                            <p><strong>Método:</strong> ${result.detection_method}</p>
                            <div style="margin-top: 15px;">
                                <p><strong>Recomendação:</strong> ${result.recommendation}</p>
                            </div>
                        </div>
                    `);
                } else {
                    showError('analysisResults', result.error || 'Erro ao gerar gráfico de outliers');
                }
            } catch (error) {
                showError('analysisResults', 'Erro de conexão: ' + error.message);
            }
        }

        // Mostra modal
        function showModal(title, content) {
            const modal = document.getElementById('plotModal');
            const modalContent = document.getElementById('modalContent');

            modalContent.innerHTML = `
                <h2 style="color: #1e293b; margin-bottom: 20px;">${title}</h2>
                ${content}
            `;

            modal.style.display = 'block';
        }

        function openProfiling() {
            if (window.profilingReportHTML) {
                const w = window.open('about:blank');
                w.document.write(window.profilingReportHTML);
                w.document.close();
            } else {
                alert('Relatório de profiling não disponível.');
            }
        }
        window.openProfiling = openProfiling;

        function createDescribeTable(data) {
            const columns = Object.keys(data || {});
            if (columns.length === 0) return '';
            const stats = Object.keys(data[columns[0]]);
            let html = '<table class="describe-table"><thead><tr><th>Estatística</th>';
            columns.forEach(col => {
                html += `<th>${col}</th>`;
            });
            html += '</tr></thead><tbody>';
            stats.forEach(stat => {
                html += `<tr><td>${stat}</td>`;
                columns.forEach(col => {
                    html += `<td>${data[col][stat]}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table>';
            return html;
        }

        // Funções de utilidade
        function showLoading(elementId, message) {
            document.getElementById(elementId).innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p style="color: #64748b;">${message}</p>
                </div>
            `;
        }

        function showError(elementId, message) {
            document.getElementById(elementId).innerHTML = `
                <div class="error">❌ ${message}</div>
            `;
        }

        function showSuccess(elementId, message) {
            document.getElementById(elementId).innerHTML = `
                <div class="success">✅ ${message}</div>
            `;
        }
    </script>
</body>
</html>

